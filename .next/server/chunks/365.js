"use strict";exports.id=365,exports.ids=[365],exports.modules={5047:(e,t,n)=>{var r=n(7389);n.o(r,"useRouter")&&n.d(t,{useRouter:function(){return r.useRouter}}),n.o(r,"useSearchParams")&&n.d(t,{useSearchParams:function(){return r.useSearchParams}})},4419:(e,t,n)=>{n.d(t,{DY:()=>d,Gf:()=>s,HZ:()=>p,JT:()=>y,f6:()=>h,h1:()=>i,lk:()=>m,nR:()=>u,tW:()=>D,yX:()=>g});var r=n(76),a=n(5920);async function o(e){try{let t=(0,r.doc)(a.db,"users",e),n=await (0,r.QT)(t);if(n.exists())return n.data();return null}catch(e){return console.error("Fehler beim Abrufen der Benutzerdaten:",e),null}}async function s(e){try{let t;console.log("\uD83D\uDD0D NEUE EINFACHE Treuerabatt-Pr\xfcfung f\xfcr User:",e);let n=(0,r.doc)(a.db,"users",e),o=await (0,r.QT)(n),s=0;if(o.exists()){let e=o.data();s=e.treatmentCountSinceLastDiscount||0,t=e.lastDiscountDate?.toDate(),console.log("\uD83D\uDCCA EINFACHER Behandlungsz\xe4hler:",{behandlungenSeitLetztemRabatt:s,letzterRabatt:t?.toISOString()||"Nie"})}else console.log("‚ÑπÔ∏è Kein Benutzerdatensatz gefunden, erstelle neuen"),await (0,r.pl)(n,{treatmentCountSinceLastDiscount:0,createdAt:r.Timestamp.now(),updatedAt:r.Timestamp.now()}),s=0;let l=s>=5,u=Math.max(0,5-s);return console.log("\uD83C\uDFAF EINFACHES Treuerabatt-Ergebnis:",{aktuellerZ√§hler:s,ben√∂tigt:5,berechtigt:l,verbleibend:u}),{isEligible:l,progress:{current:s,required:5,remaining:u},lastDiscountDate:t}}catch(e){return console.error("Fehler bei der Treuerabatt-Pr\xfcfung:",e),{isEligible:!1,progress:{current:0,required:5,remaining:5}}}}async function l(e){try{let t=function(){let e=new Date;return e.setMonth(e.getMonth()-6),e}(),n=(0,r.hJ)(a.db,"bookings");console.log("Suche Buchungen f\xfcr E-Mail:",{email:e,sixMonthsAgo:t.toISOString()});let o=(0,r.IO)(n,(0,r.ar)("email","==",e),(0,r.ar)("status","==","confirmed")),s=await (0,r.PL)(o),l=0;return s.forEach(e=>{let n=e.data();if(n.date&&new Date(n.date)>=t){let e=n.treatments?n.treatments.length:1;l+=e,console.log(`  üìã Buchung vom ${n.date}: ${e} Behandlungen`)}}),console.log(`Gefunden: ${l} Behandlungen in den letzten 6 Monaten f\xfcr ${e}`),l}catch(e){return console.error("Fehler beim Abrufen der Behandlungsanzahl:",e),0}}async function u(e){try{let t=await l(e);return{isEligible:t>=5,progress:{current:t,required:5,remaining:Math.max(0,5-t)}}}catch(e){return console.error("Fehler bei der Treuerabatt-Pr\xfcfung (E-Mail):",e),{isEligible:!1,progress:{current:0,required:5,remaining:5}}}}async function i(e){try{let t=await o(e);if(!t?.birthDate)return{isEligible:!1};let n=t.birthDate.toDate(),r=new Date,a=function(e,t=new Date){let n=t.getFullYear(),r=new Date(n,e.getMonth(),e.getDate());r<t&&r.setFullYear(n+1);let a=new Date(r);a.setDate(r.getDate()-3);let o=new Date(r);return o.setDate(r.getDate()+3),t>=a&&t<=o}(n,r),s=r.getFullYear(),l=new Date(s,n.getMonth(),n.getDate());l<r&&l.setFullYear(s+1);let u=new Date(l);u.setDate(l.getDate()-3);let i=new Date(l);i.setDate(l.getDate()+3);let c=l.getTime()-r.getTime();return{isEligible:a,daysUntilBirthday:Math.ceil(c/864e5),birthdayWeekStart:u,birthdayWeekEnd:i}}catch(e){return console.error("Fehler bei der Geburtstagsrabatt-Pr\xfcfung:",e),{isEligible:!1}}}let c=new Set;async function g(e,t){try{if(console.log("\uD83D\uDCB0 Berechne verf\xfcgbare Rabatte f\xfcr User:",e),c.has(e)){console.log("\uD83D\uDEA8 BLOCKIERT: Benutzer hat bereits einen Rabatt in dieser Session verwendet");let t=await s(e);return{type:"none",percentage:0,amount:0,description:`Treuerabatt bereits verwendet. Noch ${5-(t.progress.current||0)} Behandlungen bis zum n\xe4chsten Rabatt.`,isEligible:!1,progressInfo:t.progress||{current:0,required:5,remaining:5}}}console.log("\uD83D\uDCA1 Verwende die pr\xe4zise Loyalit\xe4tspr\xfcfung (keine pauschale Tagessperre)");let n=await s(e);if(console.log("\uD83C\uDFAF Treuerabatt-Pr\xfcfung Ergebnis:",n),n.isEligible){let e=.2*t;return console.log("‚úÖ Treuerabatt gew\xe4hrt:",{amount:e,percentage:20}),{type:"loyalty",percentage:20,amount:e,description:"Treuerabatt - Herzlichen Gl\xfcckwunsch zu Ihrer 5. Buchung!",isEligible:!0,progressInfo:n.progress}}let r=await i(e);if(console.log("\uD83C\uDF82 Geburtstagsrabatt-Pr\xfcfung Ergebnis:",r),r.isEligible){let e=.1*t;return console.log("‚úÖ Geburtstagsrabatt gew\xe4hrt:",{amount:e,percentage:10}),{type:"birthday",percentage:10,amount:e,description:"Geburtstagsrabatt - Alles Gute zum Geburtstag! \uD83C\uDF89",isEligible:!0}}return console.log("‚ÑπÔ∏è Kein Rabatt verf\xfcgbar, zeige Fortschritt:",n.progress),{type:"none",percentage:0,amount:0,description:`Noch ${n.progress.remaining} Behandlungen bis zum Treuerabatt`,isEligible:!1,progressInfo:n.progress}}catch(e){return console.error("‚ùå Fehler bei der Rabattberechnung:",e),{type:"none",percentage:0,amount:0,description:"Rabattberechnung nicht verf\xfcgbar",isEligible:!1}}}function d(e){console.log("\uD83D\uDD12 Markiere Rabatt als verwendet f\xfcr User:",e),c.add(e)}async function h(e){try{console.log(`üîÑ NEUBERECHNUNG: Z\xe4hle alle Behandlungen f\xfcr User ${e}`);let t=(0,r.doc)(a.db,"users",e),n=await (0,r.QT)(t),o=null;if(n.exists()){let e=n.data();o=e.lastDiscountDate?.toDate()||null}let s=await (0,a.Rf)(e);if(!s?.email){console.log("‚ùå Keine E-Mail f\xfcr User gefunden:",e);return}let l=(0,r.hJ)(a.db,"bookings"),u=(0,r.IO)(l,(0,r.ar)("email","==",s.email),(0,r.ar)("status","==","confirmed")),i=await (0,r.PL)(u),c=0;i.forEach(e=>{let t=e.data();if(t.date){let e=new Date(t.date);if(!o||e>o){let e=t.treatments?t.treatments.length:1;c+=e,console.log(`  ‚úÖ Buchung ${t.date}: +${e} Behandlungen`)}else console.log(`  ‚è≠Ô∏è Buchung ${t.date}: \xfcbersprungen (vor letztem Rabatt)`)}}),await (0,r.updateDoc)(t,{treatmentCountSinceLastDiscount:c,updatedAt:r.Timestamp.now()}),console.log(`‚úÖ NEUBERECHNUNG abgeschlossen: ${c} Behandlungen seit letztem Rabatt`),console.log(`üìä Letzter Rabatt war: ${o?.toISOString()||"Nie"}`)}catch(e){console.error("‚ùå Fehler bei der Neuberechnung:",e)}}async function D(e,t,n){try{if(console.log("\uD83D\uDCDD Wende Rabatt an auf Buchung:",{userId:e,bookingId:t,discountType:n.type}),!n.isEligible){console.log("‚ùå Rabatt nicht berechtigt, keine Anwendung");return}let o=(0,r.doc)(a.db,"bookings",t),s={};"loyalty"===n.type?(s.appliedLoyaltyDiscount=!0,s.loyaltyDiscountAmount=n.amount,s.loyaltyDiscountPercentage=n.percentage,console.log("\uD83C\uDFAF Treuerabatt-Daten f\xfcr Buchung:",s)):"birthday"===n.type&&(s.appliedBirthdayDiscount=!0,s.birthdayDiscountAmount=n.amount,s.birthdayDiscountPercentage=n.percentage,console.log("\uD83C\uDF82 Geburtstagsrabatt-Daten f\xfcr Buchung:",s)),await (0,r.updateDoc)(o,s),console.log("‚úÖ Buchung erfolgreich mit Rabatt aktualisiert"),"loyalty"===n.type&&(console.log("\uD83D\uDD04 Backup-Sicherheit: Treuerabatt-Reset f\xfcr Benutzer"),await b(e))}catch(e){console.error("‚ùå Fehler beim Anwenden des Rabatts:",e)}}async function b(e){try{console.log("\uD83D\uDD04 EINFACHER Reset: Setze Behandlungsz\xe4hler auf 0 nach Treuerabatt f\xfcr User:",e);let t=(0,r.doc)(a.db,"users",e),n=r.Timestamp.now();await (0,r.updateDoc)(t,{lastDiscountDate:n,isEligibleForLoyaltyDiscount:!1,treatmentCountSinceLastDiscount:0,updatedAt:n}),console.log("‚úÖ EINFACHER Reset erfolgreich:",{userId:e,treatmentCountSinceLastDiscount:0,lastDiscountDate:n.toDate().toISOString()})}catch(e){console.error("‚ùå Fehler beim Reset des Behandlungsz\xe4hlers:",e)}}async function m(e,t){try{console.log(`üî¢ Erh\xf6he Behandlungsz\xe4hler um ${t} f\xfcr User:`,e);let n=(0,r.doc)(a.db,"users",e),o=await (0,r.QT)(n),s=0;o.exists()&&(s=o.data().treatmentCountSinceLastDiscount||0);let l=s+t;await (0,r.updateDoc)(n,{treatmentCountSinceLastDiscount:l,updatedAt:r.Timestamp.now()}),console.log(`‚úÖ Behandlungsz\xe4hler aktualisiert: ${s} ‚Üí ${l}`)}catch(e){console.error("‚ùå Fehler beim Erh\xf6hen des Behandlungsz\xe4hlers:",e)}}async function f(e,t){try{console.log(`üîª Reduziere Behandlungsz\xe4hler um ${t} f\xfcr User:`,e);let n=(0,r.doc)(a.db,"users",e),o=await (0,r.QT)(n),s=0;o.exists()&&(s=o.data().treatmentCountSinceLastDiscount||0);let l=Math.max(0,s-t);await (0,r.updateDoc)(n,{treatmentCountSinceLastDiscount:l,updatedAt:r.Timestamp.now()}),console.log(`‚úÖ Behandlungsz\xe4hler reduziert: ${s} ‚Üí ${l}`)}catch(e){console.error("‚ùå Fehler beim Reduzieren des Behandlungsz\xe4hlers:",e)}}async function p(e){try{console.log(`üîç Verarbeite Stornierung f\xfcr Buchung:`,e);let t=(0,r.doc)(a.db,"bookings",e),n=await (0,r.QT)(t);if(!n.exists()){console.log("‚ùå Buchung nicht gefunden:",e);return}let o=n.data(),s=null;if(console.log("\uD83D\uDD0D SUCHE User ID f\xfcr Buchung:",{bookingId:e,email:o.email,userId:o.userId,customerId:o.customerId}),o.userId)s=o.userId,console.log("‚úÖ User ID direkt aus bookingData.userId gefunden:",s);else if(o.customerId)s=o.customerId,console.log("‚úÖ User ID aus bookingData.customerId gefunden:",s);else if(o.email)try{console.log("\uD83D\uDD0D Fallback: Suche User \xfcber E-Mail:",o.email);let e=(0,r.hJ)(a.db,"customers"),t=(0,r.IO)(e,(0,r.ar)("email","==",o.email)),n=await (0,r.PL)(t);n.empty?console.log("‚ùå Kein Kunde mit dieser E-Mail gefunden"):(s=n.docs[0].data().uid,console.log("‚úÖ User ID \xfcber E-Mail-Suche gefunden:",s))}catch(e){console.log("‚ùå Fehler bei E-Mail-Suche:",e)}if(!s){console.log("‚ùå KEINE User ID gefunden! Buchungsdaten:",{bookingId:e,verf√ºgbareFelder:Object.keys(o),userId:o.userId,customerId:o.customerId,email:o.email});return}console.log("\uD83C\uDFAF FINALE User ID f\xfcr Stornierung:",s);let l=o.treatments?o.treatments.length:1;console.log(`üìä Buchung-Details:`,{bookingId:e,userId:s,email:o.email,treatmentCount:l,status:o.status}),console.log(`üìä Verarbeite Stornierung: Status="${o.status}", Behandlungen=${l}`),await f(s,l),console.log(`‚úÖ Z\xe4hler reduziert f\xfcr Buchung (Status: ${o.status}): ${l} Behandlungen`)}catch(e){console.error("‚ùå Fehler bei der Stornierungsverarbeitung:",e)}}async function y(e,t){try{let n=(0,r.doc)(a.db,"users",e),o=await (0,r.QT)(n),s=r.Timestamp.now();if(o.exists())await (0,r.updateDoc)(n,{...t,updatedAt:s});else{let a={userId:e,name:t.name||"",email:t.email||"",birthDate:t.birthDate||null,bookingCountLast6Months:0,isEligibleForLoyaltyDiscount:!1,createdAt:s,updatedAt:s,...t};await (0,r.pl)(n,a)}}catch(e){console.error("Fehler beim Erstellen/Aktualisieren der Benutzerdaten:",e)}}}};