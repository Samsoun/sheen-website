"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[354],{9376:function(e,t,n){var a=n(5475);n.o(a,"useRouter")&&n.d(t,{useRouter:function(){return a.useRouter}}),n.o(a,"useSearchParams")&&n.d(t,{useSearchParams:function(){return a.useSearchParams}})},1405:function(e,t,n){n.d(t,{DY:function(){return D},Gf:function(){return u},HZ:function(){return C},JT:function(){return S},f6:function(){return f},h1:function(){return i},lk:function(){return y},nR:function(){return l},tW:function(){return w},yX:function(){return g}});var a=n(5978),o=n(6108);async function r(e){try{let t=(0,a.doc)(o.db,"users",e),n=await (0,a.QT)(t);if(n.exists())return n.data();return null}catch(e){return console.error("Fehler beim Abrufen der Benutzerdaten:",e),null}}async function u(e){try{let n;console.log("\uD83D\uDD0D NEUE EINFACHE Treuerabatt-Pr\xfcfung f\xfcr User:",e);let r=(0,a.doc)(o.db,"users",e),u=await (0,a.QT)(r),s=0;if(u.exists()){var t;let e=u.data();s=e.treatmentCountSinceLastDiscount||0,n=null===(t=e.lastDiscountDate)||void 0===t?void 0:t.toDate(),console.log("\uD83D\uDCCA EINFACHER Behandlungsz\xe4hler:",{behandlungenSeitLetztemRabatt:s,letzterRabatt:(null==n?void 0:n.toISOString())||"Nie"})}else console.log("ℹ️ Kein Benutzerdatensatz gefunden, erstelle neuen"),await (0,a.pl)(r,{treatmentCountSinceLastDiscount:0,createdAt:a.Timestamp.now(),updatedAt:a.Timestamp.now()}),s=0;let l=s>=5,i=Math.max(0,5-s);return console.log("\uD83C\uDFAF EINFACHES Treuerabatt-Ergebnis:",{aktuellerZähler:s,benötigt:5,berechtigt:l,verbleibend:i}),{isEligible:l,progress:{current:s,required:5,remaining:i},lastDiscountDate:n}}catch(e){return console.error("Fehler bei der Treuerabatt-Pr\xfcfung:",e),{isEligible:!1,progress:{current:0,required:5,remaining:5}}}}async function s(e){try{let t=function(){let e=new Date;return e.setMonth(e.getMonth()-6),e}(),n=(0,a.hJ)(o.db,"bookings");console.log("Suche Buchungen f\xfcr E-Mail:",{email:e,sixMonthsAgo:t.toISOString()});let r=(0,a.IO)(n,(0,a.ar)("email","==",e),(0,a.ar)("status","==","confirmed")),u=await (0,a.PL)(r),s=0;return u.forEach(e=>{let n=e.data();if(n.date&&new Date(n.date)>=t){let e=n.treatments?n.treatments.length:1;s+=e,console.log("  \uD83D\uDCCB Buchung vom ".concat(n.date,": ").concat(e," Behandlungen"))}}),console.log("Gefunden: ".concat(s," Behandlungen in den letzten 6 Monaten f\xfcr ").concat(e)),s}catch(e){return console.error("Fehler beim Abrufen der Behandlungsanzahl:",e),0}}async function l(e){try{let t=await s(e);return{isEligible:t>=5,progress:{current:t,required:5,remaining:Math.max(0,5-t)}}}catch(e){return console.error("Fehler bei der Treuerabatt-Pr\xfcfung (E-Mail):",e),{isEligible:!1,progress:{current:0,required:5,remaining:5}}}}async function i(e){try{let t=await r(e);if(!(null==t?void 0:t.birthDate))return{isEligible:!1};let n=t.birthDate.toDate(),a=new Date,o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,n=t.getFullYear(),a=new Date(n,e.getMonth(),e.getDate());a<t&&a.setFullYear(n+1);let o=new Date(a);o.setDate(a.getDate()-3);let r=new Date(a);return r.setDate(a.getDate()+3),t>=o&&t<=r}(n,a),u=a.getFullYear(),s=new Date(u,n.getMonth(),n.getDate());s<a&&s.setFullYear(u+1);let l=new Date(s);l.setDate(s.getDate()-3);let i=new Date(s);i.setDate(s.getDate()+3);let c=s.getTime()-a.getTime();return{isEligible:o,daysUntilBirthday:Math.ceil(c/864e5),birthdayWeekStart:l,birthdayWeekEnd:i}}catch(e){return console.error("Fehler bei der Geburtstagsrabatt-Pr\xfcfung:",e),{isEligible:!1}}}let c=new Set;async function g(e,t){try{if(console.log("\uD83D\uDCB0 Berechne verf\xfcgbare Rabatte f\xfcr User:",e),c.has(e)){console.log("\uD83D\uDEA8 BLOCKIERT: Benutzer hat bereits einen Rabatt in dieser Session verwendet");let t=await u(e);return{type:"none",percentage:0,amount:0,description:"Treuerabatt bereits verwendet. Noch ".concat(5-(t.progress.current||0)," Behandlungen bis zum n\xe4chsten Rabatt."),isEligible:!1,progressInfo:t.progress||{current:0,required:5,remaining:5}}}console.log("\uD83D\uDCA1 Verwende die pr\xe4zise Loyalit\xe4tspr\xfcfung (keine pauschale Tagessperre)");let n=await u(e);if(console.log("\uD83C\uDFAF Treuerabatt-Pr\xfcfung Ergebnis:",n),n.isEligible){let e=.2*t;return console.log("✅ Treuerabatt gew\xe4hrt:",{amount:e,percentage:20}),{type:"loyalty",percentage:20,amount:e,description:"Treuerabatt - Herzlichen Gl\xfcckwunsch zu Ihrer 5. Buchung!",isEligible:!0,progressInfo:n.progress}}let a=await i(e);if(console.log("\uD83C\uDF82 Geburtstagsrabatt-Pr\xfcfung Ergebnis:",a),a.isEligible){let e=.1*t;return console.log("✅ Geburtstagsrabatt gew\xe4hrt:",{amount:e,percentage:10}),{type:"birthday",percentage:10,amount:e,description:"Geburtstagsrabatt - Alles Gute zum Geburtstag! \uD83C\uDF89",isEligible:!0}}return console.log("ℹ️ Kein Rabatt verf\xfcgbar, zeige Fortschritt:",n.progress),{type:"none",percentage:0,amount:0,description:"Noch ".concat(n.progress.remaining," Behandlungen bis zum Treuerabatt"),isEligible:!1,progressInfo:n.progress}}catch(e){return console.error("❌ Fehler bei der Rabattberechnung:",e),{type:"none",percentage:0,amount:0,description:"Rabattberechnung nicht verf\xfcgbar",isEligible:!1}}}function D(e){console.log("\uD83D\uDD12 Markiere Rabatt als verwendet f\xfcr User:",e),c.add(e)}function d(){let e=Array.from(c);return console.log("\uD83D\uDCCA Aktueller Rabatt-Cache:",{size:c.size,users:e}),{size:c.size,users:e}}async function h(e){try{let r=(0,a.doc)(o.db,"users",e),u=await (0,a.QT)(r);if(u.exists()){var t,n;let a=u.data();console.log("\uD83D\uDD22 AKTUELLER BEHANDLUNGSZ\xc4HLER:",{userId:e,treatmentCountSinceLastDiscount:a.treatmentCountSinceLastDiscount||0,lastDiscountDate:(null===(n=a.lastDiscountDate)||void 0===n?void 0:null===(t=n.toDate())||void 0===t?void 0:t.toISOString())||"Nie"})}else console.log("ℹ️ Kein Benutzerdatensatz gefunden f\xfcr:",e)}catch(e){console.error("❌ Fehler beim Abrufen des Z\xe4hlers:",e)}}async function b(e,t){try{let n=(0,a.doc)(o.db,"users",e);await (0,a.updateDoc)(n,{treatmentCountSinceLastDiscount:t,updatedAt:a.Timestamp.now()}),console.log("✅ Behandlungsz\xe4hler manuell gesetzt: ".concat(t," f\xfcr User ").concat(e))}catch(e){console.error("❌ Fehler beim Setzen des Z\xe4hlers:",e)}}async function m(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;try{console.log("\uD83E\uDDEA TESTE Stornierung: ".concat(t," Behandlungen f\xfcr User ").concat(e)),await E(e,t),await h(e)}catch(e){console.error("❌ Fehler beim Test:",e)}}async function f(e){try{console.log("\uD83D\uDD04 NEUBERECHNUNG: Z\xe4hle alle Behandlungen f\xfcr User ".concat(e));let n=(0,a.doc)(o.db,"users",e),r=await (0,a.QT)(n),u=null;if(r.exists()){var t;let e=r.data();u=(null===(t=e.lastDiscountDate)||void 0===t?void 0:t.toDate())||null}let s=await (0,o.Rf)(e);if(!(null==s?void 0:s.email)){console.log("❌ Keine E-Mail f\xfcr User gefunden:",e);return}let l=(0,a.hJ)(o.db,"bookings"),i=(0,a.IO)(l,(0,a.ar)("email","==",s.email),(0,a.ar)("status","==","confirmed")),c=await (0,a.PL)(i),g=0;c.forEach(e=>{let t=e.data();if(t.date){let e=new Date(t.date);if(!u||e>u){let e=t.treatments?t.treatments.length:1;g+=e,console.log("  ✅ Buchung ".concat(t.date,": +").concat(e," Behandlungen"))}else console.log("  ⏭️ Buchung ".concat(t.date,": \xfcbersprungen (vor letztem Rabatt)"))}}),await (0,a.updateDoc)(n,{treatmentCountSinceLastDiscount:g,updatedAt:a.Timestamp.now()}),console.log("✅ NEUBERECHNUNG abgeschlossen: ".concat(g," Behandlungen seit letztem Rabatt")),console.log("\uD83D\uDCCA Letzter Rabatt war: ".concat((null==u?void 0:u.toISOString())||"Nie"))}catch(e){console.error("❌ Fehler bei der Neuberechnung:",e)}}async function w(e,t,n){try{if(console.log("\uD83D\uDCDD Wende Rabatt an auf Buchung:",{userId:e,bookingId:t,discountType:n.type}),!n.isEligible){console.log("❌ Rabatt nicht berechtigt, keine Anwendung");return}let r=(0,a.doc)(o.db,"bookings",t),u={};"loyalty"===n.type?(u.appliedLoyaltyDiscount=!0,u.loyaltyDiscountAmount=n.amount,u.loyaltyDiscountPercentage=n.percentage,console.log("\uD83C\uDFAF Treuerabatt-Daten f\xfcr Buchung:",u)):"birthday"===n.type&&(u.appliedBirthdayDiscount=!0,u.birthdayDiscountAmount=n.amount,u.birthdayDiscountPercentage=n.percentage,console.log("\uD83C\uDF82 Geburtstagsrabatt-Daten f\xfcr Buchung:",u)),await (0,a.updateDoc)(r,u),console.log("✅ Buchung erfolgreich mit Rabatt aktualisiert"),"loyalty"===n.type&&(console.log("\uD83D\uDD04 Backup-Sicherheit: Treuerabatt-Reset f\xfcr Benutzer"),await p(e))}catch(e){console.error("❌ Fehler beim Anwenden des Rabatts:",e)}}async function p(e){try{console.log("\uD83D\uDD04 EINFACHER Reset: Setze Behandlungsz\xe4hler auf 0 nach Treuerabatt f\xfcr User:",e);let t=(0,a.doc)(o.db,"users",e),n=a.Timestamp.now();await (0,a.updateDoc)(t,{lastDiscountDate:n,isEligibleForLoyaltyDiscount:!1,treatmentCountSinceLastDiscount:0,updatedAt:n}),console.log("✅ EINFACHER Reset erfolgreich:",{userId:e,treatmentCountSinceLastDiscount:0,lastDiscountDate:n.toDate().toISOString()})}catch(e){console.error("❌ Fehler beim Reset des Behandlungsz\xe4hlers:",e)}}async function y(e,t){try{console.log("\uD83D\uDD22 Erh\xf6he Behandlungsz\xe4hler um ".concat(t," f\xfcr User:"),e);let n=(0,a.doc)(o.db,"users",e),r=await (0,a.QT)(n),u=0;r.exists()&&(u=r.data().treatmentCountSinceLastDiscount||0);let s=u+t;await (0,a.updateDoc)(n,{treatmentCountSinceLastDiscount:s,updatedAt:a.Timestamp.now()}),console.log("✅ Behandlungsz\xe4hler aktualisiert: ".concat(u," → ").concat(s))}catch(e){console.error("❌ Fehler beim Erh\xf6hen des Behandlungsz\xe4hlers:",e)}}async function E(e,t){try{console.log("\uD83D\uDD3B Reduziere Behandlungsz\xe4hler um ".concat(t," f\xfcr User:"),e);let n=(0,a.doc)(o.db,"users",e),r=await (0,a.QT)(n),u=0;r.exists()&&(u=r.data().treatmentCountSinceLastDiscount||0);let s=Math.max(0,u-t);await (0,a.updateDoc)(n,{treatmentCountSinceLastDiscount:s,updatedAt:a.Timestamp.now()}),console.log("✅ Behandlungsz\xe4hler reduziert: ".concat(u," → ").concat(s))}catch(e){console.error("❌ Fehler beim Reduzieren des Behandlungsz\xe4hlers:",e)}}async function C(e){try{console.log("\uD83D\uDD0D Verarbeite Stornierung f\xfcr Buchung:",e);let t=(0,a.doc)(o.db,"bookings",e),n=await (0,a.QT)(t);if(!n.exists()){console.log("❌ Buchung nicht gefunden:",e);return}let r=n.data(),u=null;if(console.log("\uD83D\uDD0D SUCHE User ID f\xfcr Buchung:",{bookingId:e,email:r.email,userId:r.userId,customerId:r.customerId}),r.userId)u=r.userId,console.log("✅ User ID direkt aus bookingData.userId gefunden:",u);else if(r.customerId)u=r.customerId,console.log("✅ User ID aus bookingData.customerId gefunden:",u);else if(r.email)try{console.log("\uD83D\uDD0D Fallback: Suche User \xfcber E-Mail:",r.email);let e=(0,a.hJ)(o.db,"customers"),t=(0,a.IO)(e,(0,a.ar)("email","==",r.email)),n=await (0,a.PL)(t);n.empty?console.log("❌ Kein Kunde mit dieser E-Mail gefunden"):(u=n.docs[0].data().uid,console.log("✅ User ID \xfcber E-Mail-Suche gefunden:",u))}catch(e){console.log("❌ Fehler bei E-Mail-Suche:",e)}if(!u){console.log("❌ KEINE User ID gefunden! Buchungsdaten:",{bookingId:e,verfügbareFelder:Object.keys(r),userId:r.userId,customerId:r.customerId,email:r.email});return}console.log("\uD83C\uDFAF FINALE User ID f\xfcr Stornierung:",u);let s=r.treatments?r.treatments.length:1;console.log("\uD83D\uDCCA Buchung-Details:",{bookingId:e,userId:u,email:r.email,treatmentCount:s,status:r.status}),console.log('\uD83D\uDCCA Verarbeite Stornierung: Status="'.concat(r.status,'", Behandlungen=').concat(s)),await E(u,s),console.log("✅ Z\xe4hler reduziert f\xfcr Buchung (Status: ".concat(r.status,"): ").concat(s," Behandlungen"))}catch(e){console.error("❌ Fehler bei der Stornierungsverarbeitung:",e)}}async function S(e,t){try{let n=(0,a.doc)(o.db,"users",e),r=await (0,a.QT)(n),u=a.Timestamp.now();if(r.exists())await (0,a.updateDoc)(n,{...t,updatedAt:u});else{let o={userId:e,name:t.name||"",email:t.email||"",birthDate:t.birthDate||null,bookingCountLast6Months:0,isEligibleForLoyaltyDiscount:!1,createdAt:u,updatedAt:u,...t};await (0,a.pl)(n,o)}}catch(e){console.error("Fehler beim Erstellen/Aktualisieren der Benutzerdaten:",e)}}window.emergencyResetDiscounts=function e(){console.log("\uD83D\uDEA8 NOTFALL-RESET: L\xf6sche alle Rabatt-Sperren"),c.clear(),window.emergencyResetDiscounts=e,window.getDiscountCacheStatus=d,console.log("\uD83D\uDD27 Debug-Funktionen verf\xfcgbar:"),console.log("  - window.emergencyResetDiscounts() - L\xf6scht alle Rabatt-Sperren"),console.log("  - window.getDiscountCacheStatus() - Zeigt Cache-Status")},window.getDiscountCacheStatus=d,window.showTreatmentCount=h,window.setTreatmentCount=b,window.testCancellationByUserId=m,window.handleBookingCancellation=C,window.recalculateTreatmentCount=f,c.size>0&&(console.log("\uD83D\uDD04 AUTO-RESET: L\xf6sche Session-Cache bei Seitenladen"),c.clear()),console.log("\uD83D\uDD27 EINFACHES RABATT-SYSTEM DEBUG-MODUS AKTIV"),console.log("\uD83D\uDCCB Verf\xfcgbare Debug-Funktionen:"),console.log("  \uD83D\uDEA8 window.emergencyResetDiscounts() - Notfall-Reset aller Rabatt-Sperren"),console.log("  \uD83D\uDCCA window.getDiscountCacheStatus() - Zeigt aktuellen Cache-Status"),console.log("  \uD83D\uDD22 window.showTreatmentCount('[user-id]') - Zeigt aktuellen Behandlungsz\xe4hler"),console.log("  ⚙️ window.setTreatmentCount('[user-id]', [count]) - Setzt Z\xe4hler manuell"),console.log("  \uD83E\uDDEA window.testCancellationByUserId('[user-id]', [count]) - Testet Stornierung"),console.log("  \uD83D\uDCCB window.handleBookingCancellation('[booking-id]') - Testet Buchungsstornierung"),console.log("  \uD83D\uDD04 window.recalculateTreatmentCount('[user-id]') - Neuberechnung basierend auf tats\xe4chlichen Buchungen"),console.log("  \uD83D\uDCA1 Erweiterte Debug-Funktionen f\xfcr Stornierungstests")}}]);